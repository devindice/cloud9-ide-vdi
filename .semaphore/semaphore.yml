version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Build
    task:
      jobs:
        - name: docker build
          commands:
            - checkout
            - git submodule update --init --recursive
            - 'docker pull $DOCKER_USERNAME/cloud9-ide-vdi:latest || true'
            - 'docker build --cache-from=$DOCKER_USERNAME/cloud9-ide-vdi:latest $DOCKER_USERNAME/test:latest .'
      secrets:
        - name: Dockerhub
promotions:
  - name: Deploy Release Candidate
    pipeline_file: pipeline_2.yml
    auto_promote:
      when: branch = 'release' AND result = 'passed'
  - name: Deploy Production
    pipeline_file: pipeline_3.yml
    auto_promote:
      when: branch = 'master' AND result = 'passed'
